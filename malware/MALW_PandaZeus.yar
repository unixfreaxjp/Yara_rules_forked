import "pe"

rule ZeusPanda_bin {
  
	meta:
		description = "ZeusPanda binary detection"
                reference = "https://pastebin.com/ak07SACf"
		author = "unixfreaxjp"
		sha256 = "c3b32436b29c8a010fa9eb4da7ef6b8de9661f2a743905d0818096164a8da55e"
                org = "mmd"
		date = "2017-12-29"
	strings:

		$hexsts01 = { E8 ?? ?? ?? ?? E9 ?? ?? ?? ?? 50 ?? FF }
		$st01 = "irc_msg.dll" fullword nocase wide ascii
		$st02 = "\\\\.\\pipe\\pipe" fullword nocase wide ascii
		$st03 = "\\\\.\\pipe\\dpipe" fullword nocase wide ascii
		$st04 = "\\\\?\\C:\\" fullword nocase wide ascii
		$st05 = "`local vftable'" fullword nocase wide ascii
		$st06 = "file_name    = '%s'" fullword nocase wide ascii
		$st07 = "bad allocation" fullword nocase wide ascii
		$st08 = "@.data" fullword nocase wide ascii
		$st09 = "f @rf " fullword nocase wide ascii
		$st10 = "AVX512PF" fullword nocase wide ascii
		$st11 = "__clrcall" fullword nocase wide ascii

	condition:
		11 of them
		and pe.sections[0].name contains ".text"
		and pe.sections[1].name contains ".text1"
		and pe.sections[2].name contains ".rdata"
		and pe.sections[3].name contains ".data"
		and pe.sections[4].name contains ".data1"
		and pe.sections[5].name contains ".trace"
		and pe.sections[6].name contains ".rsrc"
		and pe.sections[7].name contains ".reloc"
		and pe.characteristics & pe.EXECUTABLE_IMAGE
                and filesize < 700KB 
}
rule ZeusPanda3_mem
{
 
meta:
    author = "unixfreaxjp"
    reference = "https://pastebin.com/ak07SACf"
    description = "ZeusPanda artifacts detection for forensics or malware analysis"
    org = "mmd"
    date = "20171229"

strings:
    $hexst1 = {69 73 20 70 72 6F 67 72 61 6D 20} /* PE/DLL header */
    $hexst2 = {68 A0 30 00 10 FF 15 34 30 00 10} /* push offset ModuleName; "NTDLL.DLL", call GetModuleHandleW */
    $hexst2 = {53 56 FF 75 08 FF 15 08 30 00 10} /* push  nSize/lpFilenam/hModule, call GetModuleFileNameA */
    $st01 = "Sandboxie_SingleInstanceMutex_Control"
    $st02 = "Frz_State"
    $st03 = "HKEY_USERS\Software\WINE"
    $st04 = "HKEY_LOCAL_MACHINE\Software\WINE"
    $st05 = "popupkiller.exe"
    $st06 = "stimulator.exe"
    $st07 = "TOOLS\execute.exe"
    $st08 = "wireshark"
    $st09 = "wine_get_unix_file_name"
    $st10 = "immunity"
    $st11 = "procexp"
    $st12 = "procmon"
    $st13 = "regshot"
    $st14 = "aut2exe"
    $st15 = "python"
    $st16 = "REGVXG"
    $st17 = "FILEVXG"
    $st18 = "REGSYS"
    $st19 = "FILEM"
    $st20 = "TRW"
    $st21 = "NPF_NdisWanIp"
    $st22 = "microsoft"
    $st23 = "firefox"
    
    condition:
        20 of them
}
