/* Yara rule to detect WaRAT payloads of attacker group juewangzhe.net
   Filename: MALW_waRAT.yar
   Report: https://twitter.com/malwaremustd1e/status/1081902586351955968
   Open access IOC: https://otx.alienvault.com/pulse/5c31fc6f709ed10ae9d35e3c/
   This Yara ruleset is under the GNU-GPLv2 license (http://www.gnu.org/licenses/gpl-2.0.html) 
   and  open to any user or organization, as long as you use it under this license.
*/

import "hash"
import "pe"

rule WaRAT_or_GHOSTBAK_worm_Type1 {

	meta:
		description = "Detects WaRAT_or_GHOSTBAK payloads"
		author = "unixfreaxjp"
		org = "MalwareMustDie"
		date = "2019-01-04"
	strings:
		$header = { 4D 5A }
		// $magic1 = { E8 ?? ?? ?? ?? E9 ?? ?? ?? ?? 6A ?? 68 ?? ?? }
		$st01 = "autorun.inf" fullword ascii
		$st02 = "\\GHOSTBAK.exe" nocase wide ascii
		$st03 = "WNetAddConnection2A" fullword wide ascii
		$st04 = "360sd.exe" fullword nocase wide ascii
		$st05 = "360rp.exe" fullword nocase wide ascii
		$st06 = "360Inist" fullword nocase wide ascii
		$st07 = "[autorun]\nOPEN=" nocase wide ascii
		$st08 = "\nshell\\explore\\Command=" nocase wide ascii
		$st09 = "NewArea.exe" wide ascii
	condition:
		$header at 0 and 6 of ($st0*)
}

rule WaRAT_or_GHOSTBAK_worm_Type2 {

	meta:
		description = "Detects WaRAT_or_GHOSTBAK payloads"
		author = "unixfreaxjp"
		org = "MalwareMustDie"
		date = "2019-01-04"
	strings:
		$header = { 4D 5A }
		$stb01 = "EhMQHREXHRIdEhcLCRETEhZD" fullword nocase ascii
		$stb02 = "g1fd.exe" fullword nocase ascii
		$stb03 = "WNetAddConnection2A" fullword wide ascii
		$stb04 = "NewArean.exe" wide ascii
		$stb05 = ".RAR" ascii
		$stb06 = ".ZIP" ascii
		$stb07 = "lpk.attack" fullword nocase ascii
	condition:
		$header at 0 and 3 of ($stb0*)
}

rule WaRAT_or_GHOSTBAK_RAT_Type1 {

	meta:
		description = "Detects WaRAT_or_GHOSTBAK payloads"
		author = "unixfreaxjp"
		org = "MalwareMustDie"
		date = "2019-01-04"
	strings:
		$header = { 4D 5A }
		$bin01 = { C6 45 EC 43 C6 45 ED 72 C6 45 EE 65 C6 45 EF 61 C6 45 F0 74 C6 45 F1 65 }
		$stc01 = "Ruixing" ascii
		$stc02 = "ehXBE3" fullword ascii
		$stc03 = "application/vnd.ms-powerpoint" nocase wide ascii
		$stc04 = "application/vnd.ms-excel" nocase wide ascii
		$stc05 = "application/msword" nocase wide ascii
		$stc06 = "Accept-Language: zh-cn" nocase wide ascii
		$stc07 = "URLDownloadToFileA" fullword nocase wide ascii
		$stc08 = "WSASocketA" fullword nocase wide ascii
	condition:
		$header at 0 and $bin01 and 4 of ($stc0*)
}

rule WaRAT_BatToExe_Downloader {

	meta:
		description = "Detects WaRAT_or_GHOSTBAK payloads"
		author = "unixfreaxjp"
		org = "MalwareMustDie"
		date = "2019-01-04"
	strings:
		$header = { 4D 5A }
		$std01 = "PACand.bat" fullword nocase ascii
		$std02 = "bitsadmin /transfer ExplorerDownloadjob /download /priority normal" fullword nocase wide ascii
		$std03 = "nesbbc.top" fullword nocase ascii
		$ste01 = "-b2epass" fullword nocase ascii
		$ste02 = "-b2edecompile" fullword nocase ascii
		$ste03 = "@echo off" nocase ascii
		$ste04 = "shift /0" nocase ascii
		$ste05 = "@echo on" nocase ascii
		$ste06 = "exit /b" nocase ascii
		$ste07 = "b2eprogram" fullword nocase ascii
		$ste08 = "b2eincfile" fullword nocase ascii
	condition:
		$header at 0 and 2 of ($std0*) and 4 of ($ste0*)
}

rule WaRAT_or_GHOSTBAK_RAT_Type2 {

	meta:
		description = "Detects WaRAT_or_GHOSTBAK payloads"
		author = "unixfreaxjp"
		org = "MalwareMustDie"
		date = "2019-01-04"
	strings:
		$header = { 4D 5A }
		$binb01 = { FF 24 85 F7 25 48 00 }
		$binb02 = { 33 C0 5A 59 59 64 89 10 68 40 33 48 00 }
		$binb03 = { 5F 5E 5B 8B E5 5D C3 }
		$stf01 = "Ro5Po4IX.exe" fullword nocase ascii
		$stf02 = "INSTALL" fullword ascii
		$stf03 = "SILENT" fullword ascii
		$stf04 = "UNINSTALL" fullword ascii
		$stf05 = "cmd /c shutdown" nocase wide ascii
		$stf06 = "Down.exe" fullword nocase ascii
		$stf07 = "kavpath" fullword nocase ascii
		$stf08 = "Binary with the length of 0" nocase wide ascii
		$stf09 = " Goto Repeat" nocase wide ascii
	condition:
		$header at 0 and all of ($binb0*) and 5 of ($stf0*)
}

rule WaRAT_on_UPX_290_LZMA {
    strings:
        $a = { 60 BE ?? ?? ?? ?? 8D BE ?? ?? ?? ?? 57 83 CD FF 89 E5 8D 9C 24 ?? ?? ?? ?? 31 C0 50 39 DC 75 FB 46 46 53 68 ?? ?? ?? ?? 57 83 C3 04 
53 68 ?? ?? ?? ?? 56 83 C3 04 53 50 C7 03 ?? ?? ?? ?? 90 90 }
        $b = { 60 BE ?? ?? ?? ?? 8D BE ?? ?? ?? ?? 57 83 CD FF EB 10 90 90 90 90 90 90 8A 06 46 88 07 47 01 DB 75 07 8B 1E 83 EE FC 11 DB 72 ED B8 
01 00 00 00 01 DB 75 07 8B 1E 83 EE FC 11 DB 11 C0 01 DB }
    condition:
        for any of ($*) : ( $ at pe.entry_point )

}

/*

/////// scan result ///////

samples:

www.nesbbc.top/360/148:
1.     51200 Oct 15 19:57 waNewRat360.exe| WaRAT_or_GHOSTBAK_worm_Type1
2.     26624 Oct 15 19:57 wsvchost.exe	 | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2

www.nesbbc.top/360/243:
3.    706048 Oct 15 19:57 wsvchos1.exe	 | WaRAT_or_GHOSTBAK_RAT_Type2
4.     21504 Oct 15 19:57 wsvchosc.exe	 | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2
5.     26624 Oct 15 19:57 wsvchose.exe	 | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2
6.     51200 Oct 15 19:57 wsvchosr.exe	 | WaRAT_or_GHOSTBAK_worm_Type1

www.nesbbc.top/360/batty:
7.    38400 Dec 23 21:14 Cand.exe	 | WaRAT_BatToExe_Downloader
8.    38400 Dec 23 21:14 batty.exe	 | WaRAT_BatToExe_Downloader

www.nesbbc.top/360/bbc:
9.    26624 Oct 15 19:57 T0.exe	         | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2
10.   51200 Oct 15 19:57 T1.exe	         | WaRAT_or_GHOSTBAK_worm_Type1
11.   26112 Oct 15 19:57 T2.exe	         | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2
12.   51200 Oct 15 19:57 T3.exe	         | WaRAT_or_GHOSTBAK_worm_Type1
13.   21504 Oct 15 19:57 T4.exe	         | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2
14.   26624 Oct 15 19:57 T5.exe	         | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2
15.   26624 Oct 15 19:57 T6.exe	         | UPX_290_LZMA縲・WaRAT_or_GHOSTBAK_worm_Type2
16.   51200 Oct 15 19:57 T7.exe	         | WaRAT_or_GHOSTBAK_worm_Type1
17.  706048 Oct 15 19:57 T8.exe	         | WaRAT_or_GHOSTBAK_RAT_Type2
18.   24576 Oct 15 19:57 T9.exe	         | WaRAT_or_GHOSTBAK_RAT_Type1
 
hashes:

55cfae18049799843b5fbb08aa457102d8421e0b11a4ed18c0ea27fbafc7ab54
196b6b19cc9cb9579c14ddcaf47d2c18df7e73e237387aa57851d42c618893c7
4222660b39aff67a4a5712a800f26e481c9b8867e6d3b19761d8df283f7b14ed
6a478e9f8f6b7d678cccc30f2c10ad94f765f4388dce469dd20b3a9d98eefe29
b085cea75160db91b103f2b0570e18bb08d0c4e3d9e37327fb4564f6cba7a4cc
832aa1dd5c39d521658b306abd8bf0ba62900bd68171fad11304081e4ddea515
8fb040f2ed45300a044f7e1f4a75670fd7390c7faa60846187f972148e9823f9
805726e7f96e5e99efd69e8d8021de8f18e92277bdda353d78f936cbe776bca6
b9f997dc30662d81d7b0f640be10943b2e713ec120d093dfd41487350719fb9e
9fdfa599bbbbbdfb3952334054026dbc1fc2248c6b1943d62c19b3e95f6487d0
94d46ccc43ef07f1e100bf893319ec9a925509daef36cec3279a91d13f1da186
57c77705cec29f4063c56aa91577319206b0247fc3a2f7171166b0264290c94d
c8c786ca22e50635a6ba7ea7f32158c4a723371023dbcd5c5d8a77215580c3df
b68aab65827b74a06d92c9f58a17d695a2127c2ed985e4d7ed7fa788ccb9145a
2ddf392738b1066615b60a20827240cef69abaaa2595ea8dec9f0cd824c0e83b

Rules detection:

WaRAT_or_GHOSTBAK_worm_Type1 ./www.nesbbc.top//360/148/waNewRat360.exe
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/148/wsvchost.exe
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/148/wsvchost-upx-dep
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/243/wsvchosc.exe
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/243/wsvchose.exe
WaRAT_or_GHOSTBAK_worm_Type1 ./www.nesbbc.top//360/243/wsvchosr.exe
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/243/wsvchosc-upx-dep
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/243/wsvchose-upx-dep
WaRAT_BatToExe_Downloader ./www.nesbbc.top//360/batty/Cand.exe
WaRAT_BatToExe_Downloader ./www.nesbbc.top//360/batty/batty.exe
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/bbc/T0-udp-dep
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/bbc/T0.exe
WaRAT_or_GHOSTBAK_RAT_Type2 ./www.nesbbc.top//360/243/wsvchos1.exe
WaRAT_or_GHOSTBAK_worm_Type1 ./www.nesbbc.top//360/bbc/T1.exe
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/bbc/T2.exe
WaRAT_or_GHOSTBAK_worm_Type1 ./www.nesbbc.top//360/bbc/T3.exe
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/bbc/T4.exe
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/bbc/T5.exe
WaRAT_on_UPX_290_LZMA ./www.nesbbc.top//360/bbc/T6.exe
WaRAT_or_GHOSTBAK_worm_Type1 ./www.nesbbc.top//360/bbc/T7.exe
WaRAT_or_GHOSTBAK_RAT_Type1 ./www.nesbbc.top//360/bbc/T9.exe
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/bbc/T2-udp-dep
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/bbc/T4-udp-dep
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/bbc/T5-udp-dep
WaRAT_or_GHOSTBAK_worm_Type2 ./www.nesbbc.top//360/bbc/T6-udp-dep
WaRAT_or_GHOSTBAK_RAT_Type2 ./www.nesbbc.top//360/bbc/T8.exe

#MalwareMustDie! Awareness handler/analyst: @unixfreaxjp

Sharing is caring! Your care saves the internet.

*/
